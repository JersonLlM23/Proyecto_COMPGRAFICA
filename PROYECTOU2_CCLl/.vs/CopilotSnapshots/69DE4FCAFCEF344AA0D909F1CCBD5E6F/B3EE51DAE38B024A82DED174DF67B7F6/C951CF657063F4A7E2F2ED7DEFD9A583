using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace PROYECTO_U2_CCLl
{
    public partial class Home : Form
    {
        private List<Cone3D> cones;
        private Cone3D selectedCone;
        private int coneCounter = 1;
        private float cameraDistance = 5.0f;

        public Home()
        {
            InitializeComponent();
            InitializeApp();
        }

        private void InitializeApp()
        {
            cones = new List<Cone3D>();

            // Configurar evento de doble buffering para el panel de render
            panelRender.Paint += PanelRender_Paint;
            typeof(Panel).InvokeMember("DoubleBuffered",
         System.Reflection.BindingFlags.SetProperty | System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic,
     null, panelRender, new object[] { true });

            // Configurar eventos de controles
            picCono.Click += PicCono_Click;
            boxFiguras.SelectedIndexChanged += BoxFiguras_SelectedIndexChanged;

            // Configurar eventos de transformación
            numXPosicion.ValueChanged += NumPosicion_ValueChanged;
            numYPosicion.ValueChanged += NumPosicion_ValueChanged;
            numZPosicion.ValueChanged += NumPosicion_ValueChanged;

            trackXROT.ValueChanged += TrackRotation_ValueChanged;
            trackYROT.ValueChanged += TrackRotation_ValueChanged;
            trackZROT.ValueChanged += TrackRotation_ValueChanged;

            trackXTRANS.ValueChanged += TrackTranslation_ValueChanged;
            trackYTRANS.ValueChanged += TrackTranslation_ValueChanged;
            trackZTRANS.ValueChanged += TrackTranslation_ValueChanged;

            btnResetear.Click += BtnResetear_Click;

            // Configurar colores
            comboColor.Items.AddRange(new string[] { "Azul", "Rojo", "Verde", "Amarillo", "Naranja", "Morado", "Cyan", "Magenta" });
            comboColor.SelectedIndex = 0;
            comboColor.SelectedIndexChanged += ComboColor_SelectedIndexChanged;

            // Configurar cámara
            comboCamara.Items.AddRange(new string[] { "Perspectiva", "Frontal", "Superior", "Lateral" });
            comboCamara.SelectedIndex = 0;
            comboCamara.SelectedIndexChanged += ComboCamara_SelectedIndexChanged;

            // Configurar rangos de los trackbars
            trackXROT.Minimum = -180;
            trackXROT.Maximum = 180;
            trackYROT.Minimum = -180;
            trackYROT.Maximum = 180;
            trackZROT.Minimum = -180;
            trackZROT.Maximum = 180;

            trackXTRANS.Minimum = -50;
            trackXTRANS.Maximum = 50;
            trackYTRANS.Minimum = -50;
            trackYTRANS.Maximum = 50;
            trackZTRANS.Minimum = -50;
            trackZTRANS.Maximum = 50;

            numXPosicion.Minimum = -100;
            numXPosicion.Maximum = 100;
            numYPosicion.Minimum = -100;
            numYPosicion.Maximum = 100;
            numZPosicion.Minimum = -100;
            numZPosicion.Maximum = 100;
        }

        private void PicCono_Click(object sender, EventArgs e)
        {
            // Crear un nuevo cono
            Cone3D newCone = new Cone3D($"Cono {coneCounter}");
            newCone.Color = GetSelectedColor();
            cones.Add(newCone);
            boxFiguras.Items.Add(newCone.Name);
            boxFiguras.SelectedIndex = boxFiguras.Items.Count - 1;
            coneCounter++;

            panelRender.Invalidate();
        }

        private void BoxFiguras_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (boxFiguras.SelectedIndex >= 0 && boxFiguras.SelectedIndex < cones.Count)
            {
                selectedCone = cones[boxFiguras.SelectedIndex];
                UpdateControlsFromCone();
            }
        }

        private void UpdateControlsFromCone()
        {
            if (selectedCone == null) return;

            // Actualizar controles sin disparar eventos
            numXPosicion.ValueChanged -= NumPosicion_ValueChanged;
            numYPosicion.ValueChanged -= NumPosicion_ValueChanged;
            numZPosicion.ValueChanged -= NumPosicion_ValueChanged;

            numXPosicion.Value = (decimal)selectedCone.Position.X;
            numYPosicion.Value = (decimal)selectedCone.Position.Y;
            numZPosicion.Value = (decimal)selectedCone.Position.Z;

            numXPosicion.ValueChanged += NumPosicion_ValueChanged;
            numYPosicion.ValueChanged += NumPosicion_ValueChanged;
            numZPosicion.ValueChanged += NumPosicion_ValueChanged;

            trackXROT.ValueChanged -= TrackRotation_ValueChanged;
            trackYROT.ValueChanged -= TrackRotation_ValueChanged;
            trackZROT.ValueChanged -= TrackRotation_ValueChanged;

            trackXROT.Value = (int)selectedCone.Rotation.X;
            trackYROT.Value = (int)selectedCone.Rotation.Y;
            trackZROT.Value = (int)selectedCone.Rotation.Z;

            trackXROT.ValueChanged += TrackRotation_ValueChanged;
            trackYROT.ValueChanged += TrackRotation_ValueChanged;
            trackZROT.ValueChanged += TrackRotation_ValueChanged;

            trackXTRANS.ValueChanged -= TrackTranslation_ValueChanged;
            trackYTRANS.ValueChanged -= TrackTranslation_ValueChanged;
            trackZTRANS.ValueChanged -= TrackTranslation_ValueChanged;

            trackXTRANS.Value = (int)(selectedCone.Translation.X * 10);
            trackYTRANS.Value = (int)(selectedCone.Translation.Y * 10);
            trackZTRANS.Value = (int)(selectedCone.Translation.Z * 10);

            trackXTRANS.ValueChanged += TrackTranslation_ValueChanged;
            trackYTRANS.ValueChanged += TrackTranslation_ValueChanged;
            trackZTRANS.ValueChanged += TrackTranslation_ValueChanged;
        }

        private void NumPosicion_ValueChanged(object sender, EventArgs e)
        {
            if (selectedCone == null) return;
            selectedCone.Position.X = (float)numXPosicion.Value;
            selectedCone.Position.Y = (float)numYPosicion.Value;
            selectedCone.Position.Z = (float)numZPosicion.Value;
            panelRender.Invalidate();
        }

        private void TrackRotation_ValueChanged(object sender, EventArgs e)
        {
            if (selectedCone == null) return;
            selectedCone.Rotation.X = trackXROT.Value;
            selectedCone.Rotation.Y = trackYROT.Value;
            selectedCone.Rotation.Z = trackZROT.Value;
            panelRender.Invalidate();
        }

        private void TrackTranslation_ValueChanged(object sender, EventArgs e)
        {
            if (selectedCone == null) return;
            selectedCone.Translation.X = trackXTRANS.Value / 10.0f;
            selectedCone.Translation.Y = trackYTRANS.Value / 10.0f;
            selectedCone.Translation.Z = trackZTRANS.Value / 10.0f;
            panelRender.Invalidate();
        }

        private void ComboColor_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (selectedCone != null)
            {
                selectedCone.Color = GetSelectedColor();
                panelRender.Invalidate();
            }
        }

        private void ComboCamara_SelectedIndexChanged(object sender, EventArgs e)
        {
            switch (comboCamara.SelectedIndex)
            {
                case 0: cameraDistance = 5.0f; break;  // Perspectiva
                case 1: cameraDistance = 10.0f; break; // Frontal
                case 2: cameraDistance = 15.0f; break; // Superior
                case 3: cameraDistance = 8.0f; break;  // Lateral
            }
            panelRender.Invalidate();
        }

        private void BtnResetear_Click(object sender, EventArgs e)
        {
            if (selectedCone != null)
            {
                selectedCone.Position = new Vector3D(0, 0, 0);
                selectedCone.Rotation = new Vector3D(0, 0, 0);
                selectedCone.Translation = new Vector3D(0, 0, 0);
                UpdateControlsFromCone();
                panelRender.Invalidate();
            }
        }

        private Color GetSelectedColor()
        {
            switch (comboColor.SelectedIndex)
            {
                case 1: return Color.Red;
                case 2: return Color.Green;
                case 3: return Color.Yellow;
                case 4: return Color.Orange;
                case 5: return Color.Purple;
                case 6: return Color.Cyan;
                case 7: return Color.Magenta;
                default: return Color.Blue;
            }
        }

        private void PanelRender_Paint(object sender, PaintEventArgs e)
        {
            Graphics g = e.Graphics;
            g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;

            // Dibujar ejes de referencia
            DrawAxes(g);

            // Dibujar todos los conos
            foreach (var cone in cones)
            {
                cone.Draw(g, panelRender.Size, cameraDistance);
            }

            // Resaltar el cono seleccionado
            if (selectedCone != null)
            {
                using (Pen highlightPen = new Pen(Color.White, 1))
                {
                    highlightPen.DashStyle = System.Drawing.Drawing2D.DashStyle.Dash;
                    Vector3D[] vertices = selectedCone.GenerateVertices();
                    PointF[] projectedPoints = new PointF[vertices.Length];

                    for (int i = 0; i < vertices.Length; i++)
                    {
                        Vector3D transformed = selectedCone.TransformVertex(vertices[i]);
                        projectedPoints[i] = selectedCone.ProjectTo2D(transformed, cameraDistance, panelRender.Size);
                    }

                    // Dibujar bounding box
                    float minX = projectedPoints.Min(p => p.X);
                    float maxX = projectedPoints.Max(p => p.X);
                    float minY = projectedPoints.Min(p => p.Y);
                    float maxY = projectedPoints.Max(p => p.Y);
                    g.DrawRectangle(highlightPen, minX - 5, minY - 5, maxX - minX + 10, maxY - minY + 10);
                }
            }
        }

        private void DrawAxes(Graphics g)
        {
            int centerX = panelRender.Width / 2;
            int centerY = panelRender.Height / 2;
            int axisLength = 50;

            // Eje X (rojo)
            using (Pen penX = new Pen(Color.Red, 2))
            {
                g.DrawLine(penX, centerX, centerY, centerX + axisLength, centerY);
                g.DrawString("X", Font, Brushes.Red, centerX + axisLength + 5, centerY - 10);
            }

            // Eje Y (verde)
            using (Pen penY = new Pen(Color.Green, 2))
            {
                g.DrawLine(penY, centerX, centerY, centerX, centerY - axisLength);
                g.DrawString("Y", Font, Brushes.Green, centerX + 5, centerY - axisLength - 15);
            }

            // Eje Z (azul) - representado diagonalmente
            using (Pen penZ = new Pen(Color.Blue, 2))
            {
                g.DrawLine(penZ, centerX, centerY, centerX - axisLength / 2, centerY + axisLength / 2);
                g.DrawString("Z", Font, Brushes.Blue, centerX - axisLength / 2 - 15, centerY + axisLength / 2 + 5);
            }
        }
    }
}
